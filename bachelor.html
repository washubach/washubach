<!DOCTYPE html>
<html>
<head>
    <title>Bachelor Poll</title>
    <style> /* Basic styling for layout */
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        #poll-container div.poll-item {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc; /* Changed border color */
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #poll-container div.poll-item span.item-text {
            margin-right: auto; /* Pushes buttons to the right */
            padding-right: 15px; /* Spacing between text and buttons */
        }
        button {
            margin-left: 5px;
            padding: 5px 10px;
            cursor: pointer;
            background-color: #eee; /* Light grey background */
            border: 1px solid #aaa;
            border-radius: 3px;
        }
        button:hover {
             background-color: #ddd;
        }
        input[type="text"] {
            padding: 6px;
            margin-right: 5px;
            border: 1px solid #aaa;
            border-radius: 3px;
        }
        .add-section {
             margin-top: 20px; /* Space above add section */
             padding-top: 15px;
             border-top: 1px solid #eee;
        }
        .status-message {
            margin-left: 10px;
            font-style: italic;
        }
        .error-message {
            color: #D8000C; /* Error red */
            background-color: #FFD2D2; /* Light red background */
            border: 1px solid #D8000C;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
         .error-details {
            color: #A00000;
            background-color: #FDD;
            border: 1px solid #A00000;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap; /* Allows wrapping of long lines */
            word-break: break-all; /* Breaks long strings */
            font-family: monospace;
            font-size: 0.9em;
         }
         hr {
             display: none; /* Hide default hr, using styled border instead */
         }
         #loading-indicator {
             font-style: italic;
             color: #555;
         }
    </style>
</head>
<body>
    <h1>Bachelor Poll</h1>

    <div id="poll-container">
        <p id="loading-indicator">Loading poll...</p>
    </div>

    <div class="add-section">
        <input type="text" id="newName" placeholder="Enter a new name">
        <button onclick="addNewNameToPoll()">Add Name</button>
         <span id="add-status" class="status-message"></span> </div>

    <script>
        // --- Configuration ---
        // UPDATED with your new deployment URL
        const webAppUrl = "https://script.google.com/macros/s/AKfycbwN2FDsNXMNRM8FL-nNWhjW9JtKi0odCGHWlCeGM9j0tczoUAXenwSAnncSu3_nDSs/exec";
        const currentSheetName = "Bachelor"; // The sheet name for this poll

        // --- DOM Elements ---
        const pollContainer = document.getElementById("poll-container");
        const nameInput = document.getElementById("newName");
        const addStatusSpan = document.getElementById("add-status");
        const loadingIndicator = document.getElementById("loading-indicator");

        // --- Fetching and Displaying Data ---

        async function fetchData(sheetName) {
            console.log("Fetching data from:", `${webAppUrl}?action=getData&sheetName=${sheetName}`);
            let responseData = null;

            try {
                const response = await fetch(`${webAppUrl}?action=getData&sheetName=${sheetName}`);
                console.log("Fetch Response Status:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Fetch Error:", response.statusText, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`);
                }

                responseData = await response.json();
                console.log("Raw JSON Data Received:", responseData);

                if (responseData && responseData.error) {
                    console.error("Server-side error:", responseData.error);
                    throw new Error("Server error: " + responseData.error);
                }

                if (!Array.isArray(responseData)) {
                    console.error("Data received is not an array:", responseData);
                    throw new Error("Invalid data format: Expected an array, but received an object.");
                }

                return responseData;

            } catch (error) {
                console.error("Error in fetchData:", error);

                // Construct error display
                let displayError = `<span class="error-message">${error.message}</span>`;
                let detailsAvailable = false;

                 if (error.message.startsWith("Invalid data format") && responseData) {
                     displayError += `<br><br><strong>Raw Data Received (Object):</strong><div class="error-details">${JSON.stringify(responseData, null, 2)}</div>`;
                     detailsAvailable = true;
                 } else if (error.message.startsWith("Server error:") && responseData) {
                     displayError += `<br><br><strong>Raw Error Object from Server:</strong><div class="error-details">${JSON.stringify(responseData, null, 2)}</div>`;
                     detailsAvailable = true;
                 } else if (!error.message.startsWith("Server error:") && responseData && typeof responseData === 'object') {
                     displayError += `<br><br><strong>Potentially Relevant Data Received:</strong><div class="error-details">${JSON.stringify(responseData, null, 2)}</div>`;
                     detailsAvailable = true;
                 }

                if (!detailsAvailable) {
                     displayError += '<br><br><span style="font-size: 0.9em; font-style: italic;">Check browser console (F12) and Google Apps Script Executions logs for more details.</span>';
                }

                // Display error in the poll container
                pollContainer.innerHTML = `<div class="error-message">${displayError}</div>`;
                return null; // Indicate failure
            }
        }

        async function loadPoll(sheetName) {
            loadingIndicator.style.display = 'block'; // Show loading
            pollContainer.innerHTML = ''; // Clear previous items (but keep indicator parent)
            pollContainer.appendChild(loadingIndicator);


            const data = await fetchData(sheetName);

            loadingIndicator.style.display = 'none'; // Hide loading

            if (data === null) return; // Stop if fetchData failed (error already displayed)

            // Clear container completely *after* successful fetch
            pollContainer.innerHTML = "";

             if (data.length === 0) {
                 pollContainer.innerHTML = "<p>No names added to the poll yet.</p>";
                 return;
             }

            // Sort data alphabetically by name (optional)
            data.sort((a, b) => (a.Name || "").localeCompare(b.Name || ""));

            data.forEach(item => {
                if (item && typeof item === 'object' && 'Name' in item) {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = 'poll-item'; // Add class for styling

                    const upvotes = Number(item.Upvotes) || 0;
                    const downvotes = Number(item.Downvotes) || 0;

                    const encodedName = encodeURIComponent(item.Name);
                    const displayName = item.Name; // Display decoded name

                    itemDiv.innerHTML = `
                        <span class="item-text">
                            <strong>${displayName}</strong> &nbsp; | &nbsp; Up: ${upvotes}, Down: ${downvotes}
                        </span>
                        <div>
                            <button title="Upvote ${displayName}" onclick="updateVoteOnPoll('${sheetName}', '${encodedName}', 'upvote', this)">⬆️ Upvote</button>
                            <button title="Downvote ${displayName}" onclick="updateVoteOnPoll('${sheetName}', '${encodedName}', 'downvote', this)">⬇️ Downvote</button>
                        </div>
                    `;
                    pollContainer.appendChild(itemDiv);
                } else {
                    console.warn("Skipping invalid item:", item);
                }
            });

            console.log("Poll display updated.");
        }

        // --- Adding and Updating Data ---

        async function addNewNameToPoll() {
            const name = nameInput.value.trim();
            addStatusSpan.textContent = "";
            addStatusSpan.style.color = "";

            if (!name) {
                alert("Please enter a name.");
                return;
            }

             const addButton = nameInput.nextElementSibling;
             addButton.disabled = true;
             addStatusSpan.textContent = "Adding...";
             addStatusSpan.style.color = "orange";

            try {
                const encodedName = encodeURIComponent(name);
                const response = await fetch(`${webAppUrl}?action=addData&sheetName=${currentSheetName}&name=${encodedName}`);

                 if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Add Name Fetch Error:", response.statusText, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                 }

                const result = await response.json();
                console.log("Add Name Result:", result);

                if (result.success) {
                    nameInput.value = "";
                    addStatusSpan.textContent = "Name added!";
                    addStatusSpan.style.color = "green";
                    await loadPoll(currentSheetName); // Reload poll
                } else {
                     addStatusSpan.textContent = "Error: " + (result.message || result.error || "Could not add name.");
                     addStatusSpan.style.color = "red";
                }
            } catch (error) {
                console.error("Error in addNewNameToPoll:", error);
                addStatusSpan.textContent = "Error adding name. Check console.";
                addStatusSpan.style.color = "red";
            } finally {
                 addButton.disabled = false;
                 setTimeout(() => { addStatusSpan.textContent = ""; addStatusSpan.style.color = ""; }, 4000);
            }
        }

        // Added 'buttonElement' parameter to disable the correct buttons
        async function updateVoteOnPoll(sheetName, encodedName, voteType, buttonElement) {
            const name = decodeURIComponent(encodedName);
            console.log(`Updating ${voteType} for: ${name} in sheet: ${sheetName}`);

            // Disable buttons within the specific item's div
             const itemDiv = buttonElement.closest('.poll-item');
             const buttonsInItem = itemDiv ? itemDiv.querySelectorAll('button') : [];
             buttonsInItem.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`${webAppUrl}?action=updateVote&sheetName=${sheetName}&name=${encodedName}&voteType=${voteType}`);

                if (!response.ok) {
                     const errorText = await response.text();
                     console.error("Update Vote Fetch Error:", response.statusText, errorText);
                     throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("Update Vote Result:", result);

                if (result.success) {
                    // Instead of full reload, could potentially update just this item's text
                    // For simplicity now, just reload the whole poll
                    await loadPoll(sheetName);
                } else {
                    alert("Error updating vote: " + (result.error || "Unknown error"));
                     buttonsInItem.forEach(btn => btn.disabled = false); // Re-enable on error
                }
            } catch (error) {
                console.error("Error in updateVoteOnPoll:", error);
                alert("Failed to update vote. Check console for details.");
                 buttonsInItem.forEach(btn => btn.disabled = false); // Re-enable on error
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPoll(currentSheetName);
        });

    </script>
</body>
</html>
