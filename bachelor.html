<!DOCTYPE html>
<html>
<head>
    <title>Bachelor Poll</title>
    <style> /* Optional: Basic styling for clarity */
        #poll-container div {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #eee;
        }
        button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <h1>Bachelor Poll</h1>

    <div id="poll-container">Loading poll...</div>

    <hr> <div>
        <input type="text" id="newName" placeholder="Enter a new name">
        <button onclick="addNewNameToPoll()">Add Name</button>
         <span id="add-status" style="margin-left: 10px; color: green;"></span> </div>

    <hr> <div>
        </div>

    <script>
        const webAppUrl = "https://script.google.com/macros/s/AKfycbz6ANZkWCnjgLfbECPnBG_gBJuGOQOFdUXUokGH-BLPL5bT67A_g3_cjiVmCdzhl9JW/exec"; // Your specific Web App URL
        const currentSheetName = "Bachelor"; // Define the sheet name for this page

        // --- Fetching and Displaying Data ---

        async function fetchData(sheetName) {
            console.log("Fetching data from:", `${webAppUrl}?action=getData&sheetName=${sheetName}`);
            try {
                const response = await fetch(`${webAppUrl}?action=getData&sheetName=${sheetName}`);
                console.log("Fetch Response Status:", response.status); // Log status code

                if (!response.ok) {
                    // Log error response text if fetch failed
                    const errorText = await response.text();
                    console.error("Fetch Error:", response.statusText, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${response.statusText}`);
                }

                const data = await response.json(); // Try to parse JSON
                 console.log("Raw JSON Data Received:", data); // Log the parsed data

                 // Check if the Google Apps Script returned an error object
                 if (data && data.error) {
                     console.error("Server-side error:", data.error);
                     throw new Error("Server error: " + data.error);
                 }

                return data; // Return the actual data array
            } catch (error) {
                console.error("Error in fetchData:", error);
                 // Display error to the user in the poll container
                const container = document.getElementById("poll-container");
                container.innerHTML = `<p style="color: red;">Error loading poll data: ${error.message}. Check console for details.</p>`;
                return null; // Indicate failure
            }
        }

        async function loadPoll(sheetName) {
            const container = document.getElementById("poll-container");
            container.innerHTML = "Loading..."; // Show loading indicator

            const data = await fetchData(sheetName);

            if (data === null) return; // Stop if fetchData failed

            // Clear container *after* successful fetch
            container.innerHTML = "";

             if (!Array.isArray(data)) {
                 console.error("Data received is not an array:", data);
                 container.innerHTML = `<p style="color: red;">Error: Received invalid data format from server.</p>`;
                 return;
             }

             if (data.length === 0) {
                 container.innerHTML = "<p>No names added to the poll yet.</p>";
                 return;
             }

            // Sort data alphabetically by name (optional)
            data.sort((a, b) => (a.Name || "").localeCompare(b.Name || ""));

            data.forEach(item => {
                 // Validate item structure before using it
                if (item && typeof item === 'object' && 'Name' in item) {
                    console.log("Processing Item:", item); // Debug each valid item
                    const itemDiv = document.createElement("div");

                    // Ensure votes are numbers, default to 0 if missing or not a number
                    const upvotes = Number(item.Upvotes) || 0;
                    const downvotes = Number(item.Downvotes) || 0;

                     // Use encodeURIComponent for names that might have special characters
                    const encodedName = encodeURIComponent(item.Name);

                    itemDiv.innerHTML = `
                        <strong>${item.Name}</strong>:
                        Upvotes: ${upvotes},
                        Downvotes: ${downvotes}
                        <button onclick="updateVoteOnPoll('${sheetName}', '${encodedName}', 'upvote')">Upvote</button>
                        <button onclick="updateVoteOnPoll('${sheetName}', '${encodedName}', 'downvote')">Downvote</button>
                    `;
                    container.appendChild(itemDiv);
                } else {
                    console.warn("Skipping invalid item:", item);
                }
            });

            console.log("Poll display updated. Current HTML:", container.innerHTML);
        }

        // --- Adding and Updating Data ---

        async function addNewNameToPoll() {
            const nameInput = document.getElementById("newName");
            const statusSpan = document.getElementById("add-status");
            const name = nameInput.value.trim(); // Trim whitespace

             statusSpan.textContent = ""; // Clear previous status

            if (!name) {
                alert("Please enter a name.");
                return;
            }

             // Disable button temporarily
             const addButton = nameInput.nextElementSibling; // Assumes button is immediately after input
             addButton.disabled = true;
             statusSpan.textContent = "Adding...";
             statusSpan.style.color = "orange";


            try {
                 console.log("Adding name:", name, "to sheet:", currentSheetName);
                 // Encode the name for the URL query string
                const encodedName = encodeURIComponent(name);
                const response = await fetch(`${webAppUrl}?action=addData&sheetName=${currentSheetName}&name=${encodedName}`);

                 if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Add Name Fetch Error:", response.statusText, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                 }

                const result = await response.json();
                console.log("Add Name Result:", result);

                if (result.success) {
                    nameInput.value = ""; // Clear input field
                    statusSpan.textContent = "Name added!";
                    statusSpan.style.color = "green";
                    await loadPoll(currentSheetName); // Reload the poll to show the new name
                } else {
                     // Handle specific errors like 'name already exists'
                     statusSpan.textContent = "Error: " + (result.message || result.error || "Could not add name.");
                     statusSpan.style.color = "red";
                }
            } catch (error) {
                console.error("Error in addNewNameToPoll:", error);
                statusSpan.textContent = "Error adding name. Check console.";
                statusSpan.style.color = "red";
            } finally {
                 // Re-enable button
                 addButton.disabled = false;
                 // Optionally clear status message after a few seconds
                 setTimeout(() => { statusSpan.textContent = ""; }, 3000);
            }
        }

        async function updateVoteOnPoll(sheetName, encodedName, voteType) {
            // Decode name for logging if needed, but keep it encoded for the URL
            const name = decodeURIComponent(encodedName);
             console.log(`Updating ${voteType} for: ${name} in sheet: ${sheetName}`);

            // Optional: Add visual feedback (e.g., disable buttons briefly)

             try {
                const response = await fetch(`${webAppUrl}?action=updateVote&sheetName=${sheetName}&name=${encodedName}&voteType=${voteType}`);

                if (!response.ok) {
                     const errorText = await response.text();
                     console.error("Update Vote Fetch Error:", response.statusText, errorText);
                     throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                 console.log("Update Vote Result:", result);

                if (result.success) {
                    await loadPoll(sheetName); // Reload the poll to show updated counts
                } else {
                    alert("Error updating vote: " + (result.error || "Unknown error"));
                }
            } catch (error) {
                console.error("Error in updateVoteOnPoll:", error);
                alert("Failed to update vote. Check console for details.");
            }
        }

        // --- Initial Load ---
        // Load the poll for the specific sheet when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadPoll(currentSheetName);
        });

    </script>
</body>
</html>
